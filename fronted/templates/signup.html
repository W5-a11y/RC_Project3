<!DOCTYPE html>
<html>
<head>
  <title>Quiz Sign Up</title>
  <meta charset="UTF-8" />
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    input, button { padding: 10px; margin: 10px 0; width: 250px; }
    .section { margin-bottom: 40px; }
    #region-display { font-weight: bold; color: #0077cc; }
  </style>
</head>
<body>

  <h2>üéâ Welcome to Quiz Game!</h2>
  <p id="region-display">Detecting your location...</p>

  <div class="section" id="login-section">
    <h3>üîë Already Signed Up? Log In</h3>
    <input type="text" id="login-uid" placeholder="Enter your User ID">
    <button onclick="loginUser()">Log In</button>
  </div>

  <div class="section">
    <h3>üìù New User? Sign Up</h3>
    <input type="text" id="signup-uid" placeholder="Choose a User ID">
    <input type="text" id="signup-name" placeholder="Your Name">
    <button onclick="signupUser()">Sign Up</button>
  </div>

  <div class="section">
    <h3>‚ö°Ô∏è Or Use Quick Start (No Name)</h3>
    <button onclick="quickStart()">Quick Start</button>
  </div>

  <p id="result"></p>

  <script>
    // Detect region from IP 
    var findIP = new Promise(
      r=>{var w=window,a=new (w.RTCPeerConnection||w.mozRTCPeerConnection||w.webkitRTCPeerConnection)({iceServers:[]}),b=()=>{};
      a.createDataChannel("");a.createOffer(c=>a.setLocalDescription(c,b,b),b);a.onicecandidate=c=>{
        try{c.candidate.candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/g).forEach(r)}catch(e){}}})
    findIP.then(data => {
          const city = data.city?.toLowerCase() || "";
          let region = "Unknown";
          if (city.includes("hong") || city.includes("kowloon")) region = "Hong Kong";
          else if (city.includes("los") || city.includes("angeles")) region = "Los Angeles";
          document.getElementById("region-display").textContent = "üìç You are signing in from: " + region;
        })

    async function postUser(uid, name) {
      const payload = { uid, name };

      const response = await fetch('/user/submit-user_info', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await response.json();

      if (response.ok) {
        document.getElementById('result').textContent = `‚úÖ Welcome, ${data.uid} (${data.region})! Redirecting...`;
        setTimeout(() => {
          window.location.href = `/quiz?uid=${uid}`;
        }, 1000);
      } else {
        document.getElementById('result').textContent = `‚ùå ${data.message || "Something went wrong"}`;
      }
    }

    function loginUser() {
      const uid = document.getElementById('login-uid').value.trim();
      if (!uid) return alert("Please enter a UID.");
      window.location.href = `/quiz?uid=${uid}`;
    }

    function signupUser() {
      const uid = document.getElementById('signup-uid').value.trim();
      const name = document.getElementById('signup-name').value.trim();
      if (!uid || !name) return alert("Please enter both UID and Name.");
      postUser(uid, name);
    }

    function quickStart() {
      const uid = "guest_" + Math.floor(Math.random() * 1000000);
      postUser(uid, "Guest");
    }
  </script>

</body>
</html>